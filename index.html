<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Okçuluk Oyunu: Yer Şekilleri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            touch-action: manipulation; /* Mobil cihazlarda çift tıklama zoom'unu engeller */
        }
        #game-container {
            background-image: url('https://images.unsplash.com/photo-1448375240586-882707db888b?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            overflow: hidden;
            user-select: none;
            transition: transform 0.1s;
        }
        .shake {
            animation: shake 0.3s;
        }
        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(-4px, 2px); }
            50% { transform: translate(4px, -2px); }
            75% { transform: translate(-2px, -4px); }
        }
        .target {
            position: absolute;
            width: 85px;
            height: 85px;
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            border: 3px solid #c0a070;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-family: 'Cinzel', serif;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 3px black;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            animation: float 6s ease-in-out infinite;
        }
        .target.near {
            width: 85px;
            height: 85px;
            font-size: 0.85rem;
            filter: blur(0px);
            z-index: 10;
        }
        .target.far {
            width: 85px;
            height: 85px;
            font-size: 0.85rem;
            filter: blur(0px);
            opacity: 1;
            z-index: 5;
        }
        .target:hover {
            transform: scale(1.05);
            border-color: #f0e0b0;
        }
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0px); }
        }
        #player-hud {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            pointer-events: none; /* HUD'ın tıklamaları engellememesi için */
        }
        #bow-container {
            position: relative;
            width: 180px;
            height: 180px;
            transform: translateY(50px);
            transition: transform 0.1s ease-out;
            transform-origin: center center;
        }
        #arrow {
            position: absolute;
            width: 90px;
            height: 90px;
            left: 50%;
            bottom: 50%;
            transform: translate(-50%, 50%);
            z-index: 15;
            pointer-events: none;
        }
        #arrow.fired {
            transform: scale(0.1) rotate(-2deg);
        }
        #arrow.flying {
            transition: all 0.8s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        .stuck-arrow {
            position: absolute;
            width: 70px;
            height: 70px;
            z-index: 15;
            pointer-events: none;
            transform: translate(-50%, -50%);
            animation: stuckWiggle 0.3s ease-out forwards;
            filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.5));
        }
        @keyframes stuckWiggle {
            0%, 100% { transform: translate(-50%, -50%) rotate(0deg); }
            25% { transform: translate(-50%, -50%) rotate(-3deg); }
            75% { transform: translate(-50%, -50%) rotate(3deg); }
        }
        
        /* Impact Animasyonları */
        @keyframes targetImpact {
            0% { transform: scale(1) rotate(0deg); }
            20% { transform: scale(1.15) rotate(-2deg); }
            50% { transform: scale(0.95) rotate(2deg); opacity: 0.8; }
            100% { transform: scale(1.1) rotate(0deg); opacity: 0; }
        }
        
        @keyframes targetShatter {
            0% { 
                transform: scale(1) rotate(0deg); 
                filter: blur(0px) brightness(1); 
                opacity: 1; 
            }
            30% { 
                transform: scale(1.4) rotate(5deg); 
                filter: blur(3px) brightness(1.5); 
                opacity: 0.8; 
            }
            60% { 
                transform: scale(1.8) rotate(-3deg); 
                filter: blur(8px) brightness(2); 
                opacity: 0.3; 
            }
            100% { 
                transform: scale(2.5) rotate(0deg); 
                filter: blur(15px) brightness(3); 
                opacity: 0; 
            }
        }
        
        .target.hit {
            animation: targetImpact 0.4s ease-out forwards !important;
        }
        
        .target.shatter {
            animation: targetShatter 0.5s ease-out forwards !important;
        }
        
        /* Partikül efekti */
        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 100;
        }
        
        @keyframes particleBurst {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
        
        @keyframes cameraShake {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-3px, 2px); }
            20% { transform: translate(3px, -2px); }
            30% { transform: translate(-2px, -3px); }
            40% { transform: translate(2px, 3px); }
            50% { transform: translate(-3px, 1px); }
            60% { transform: translate(3px, -1px); }
            70% { transform: translate(-1px, -2px); }
            80% { transform: translate(1px, 2px); }
            90% { transform: translate(-2px, 1px); }
        }
        
        .shake {
            animation: cameraShake 0.3s ease-in-out;
        }
        #power-meter {
            position: absolute;
            bottom: 320px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 20px;
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            border: 2px solid #c0a070;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        #power-meter.active {
            opacity: 1;
        }
        #power-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4ade80, #fbbf24, #ef4444);
            transition: width 0.05s;
        }
        #wind-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            padding: 10px 15px;
            border-radius: 10px;
            border: 2px solid #c0a070;
            color: white;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #wind-arrow {
            width: 30px;
            height: 30px;
            color: #ef4444;
            transition: all 0.5s ease;
            transform-origin: center center;
        }
        #lives-container {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 8px;
        }
        .heart {
            fill: #ef4444;
            transition: fill 0.3s;
        }
        .heart.lost {
            fill: #444;
            filter: drop-shadow(0 0 2px #111);
        }
        .hidden {
            display: none;
        }
        #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.75);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        /* Başlangıç Ekranı */
        #intro-screen {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            position: relative;
            overflow: hidden;
        }
        #intro-screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('https://images.unsplash.com/photo-1448375240586-882707db888b?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            opacity: 0.15;
            filter: blur(3px);
        }
        .intro-content {
            position: relative;
            z-index: 1;
        }
        .intro-icon {
            animation: floatSlow 4s ease-in-out infinite;
        }
        @keyframes floatSlow {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-15px); }
        }
        .btn-start {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #c0a070 0%, #d4af7a 100%);
            box-shadow: 0 4px 15px rgba(192, 160, 112, 0.4);
        }
        .btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(192, 160, 112, 0.6);
        }
        .outcome-badge {
            background: rgba(192, 160, 112, 0.1);
            border: 2px solid #c0a070;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center h-screen">

    <div class="w-full max-w-5xl mx-auto p-4 aspect-[16/9] relative">
        
        <!-- BAŞLANGIÇ EKRANI -->
        <div id="intro-screen" class="relative w-full h-full rounded-2xl shadow-lg border-4 border-black">
            <!-- Tam Ekran Butonu -->
            <button id="fullscreen-btn" class="absolute top-4 right-4 z-10 bg-black/50 hover:bg-black/70 text-white p-2 rounded-lg transition-all duration-300 backdrop-blur-sm border border-gray-600">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/>
                </svg>
            </button>
            
            <div class="intro-content flex flex-col items-center justify-center h-full px-4 sm:px-8 text-center">
                
                <!-- Başlık -->
                <h1 class="text-xl sm:text-3xl font-bold text-white mb-3 sm:mb-6 font-['Cinzel']">
                    Okçuluk Oyunu
                </h1>

                <!-- Konu ve Kazanım Kutusu -->
                <div class="bg-black/30 backdrop-blur-sm rounded-lg p-3 sm:p-4 w-full max-w-sm sm:max-w-xl mb-4 sm:mb-6 border border-gray-600">
                    <div class="mb-2 sm:mb-3">
                        <div class="text-[10px] sm:text-xs text-gray-400 uppercase tracking-wider mb-1">Konu</div>
                        <div class="text-xs sm:text-sm text-white font-semibold leading-tight">
                            Akarsuların Aşınım ve Birikim Süreçlerine Etkisi
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-600 pt-2 sm:pt-3 mb-2 sm:mb-3">
                        <div class="text-[10px] sm:text-xs text-gray-400 uppercase tracking-wider mb-1">Öğrenme Çıktısı</div>
                        <div class="outcome-badge rounded-md px-2 sm:px-3 py-1.5 sm:py-2 text-[10px] sm:text-xs text-gray-200 leading-tight">
                            <span class="text-amber-400 font-semibold">COĞ.10.3.3.</span> 
                            Yeryüzü şekillerinin oluşumunu aşınım ve birikim süreçleri açısından çözümleyebilme
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-600 pt-2 sm:pt-3">
                        <div class="text-[10px] sm:text-xs text-amber-400 uppercase tracking-wider mb-2 font-semibold">Amaç</div>
                        <div class="text-xs sm:text-sm text-white font-medium leading-relaxed bg-gradient-to-r from-amber-500/10 to-orange-500/10 p-3 sm:p-4 rounded border-l-4 border-amber-400">
                            Ekrana gelen yer şekillerinden hangisinin akarsular tarafından oluşturulduğunu belirleyip hedef alarak okla vurmanız gerekmektedir.
                        </div>
                    </div>
                </div>

                <!-- Başla Butonu -->
                <button id="start-activity-btn" class="btn-start text-white font-bold py-2 px-6 sm:py-3 sm:px-8 rounded-full text-sm sm:text-base font-['Cinzel'] cursor-pointer">
                    Etkinliğe Başla
                </button>
            </div>
        </div>

        <!-- OYUN EKRANI -->
        <div id="game-wrapper" class="hidden w-full h-full">
            <div id="game-container" class="relative w-full h-full rounded-2xl shadow-lg border-4 border-black">
            
            <div id="status-bar" class="absolute top-4 left-1/2 -translate-x-1/2 z-20 flex justify-center items-center p-3 bg-black/50 rounded-xl shadow-md">
                 <div class="text-2xl font-bold text-white font-['Cinzel']">Puan: <span id="score">0</span></div>
            </div>
            
            <div id="lives-container"></div>
            <div id="player-hud">
                <div id="bow-container">
                    <img src="yay.png" alt="Yay" style="position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; height: 100%; object-fit: contain; z-index: 10; pointer-events: none;">
                    
                    <!-- Yay kirişi (dinamik) -->
                    <svg id="bow-string-svg" viewBox="0 0 100 100" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; z-index: 11; pointer-events: none; opacity: 0; transition: opacity 0.2s;">
                        <path id="bow-string-path" d="M 50,10 L 50,90" stroke="#e8dcc8" stroke-width="1.5" fill="none" stroke-linecap="round"/>
                    </svg>
                    
                    <div id="arrow">
                        <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                             <!-- Ok şaftı -->
                             <line x1="50" y1="10" x2="50" y2="90" stroke="#a0522d" stroke-width="3" stroke-linecap="round"/>
                             <!-- Ok ucu (metal) -->
                             <path d="M 50,0 L 43,15 L 57,15 Z" fill="#c0c0c0" stroke="#999" stroke-width="0.5"/>
                             <!-- Ok kuyruk tüyleri -->
                             <path d="M 45,85 L 50,90 L 55,85" fill="none" stroke="#8b4513" stroke-width="2"/>
                             <path d="M 46,80 L 50,85 L 54,80" fill="none" stroke="#8b4513" stroke-width="2"/>
                        </svg>
                    </div>
                </div>
            </div>

            <div id="power-meter">
                <div id="power-fill"></div>
            </div>
            <div id="wind-indicator">
                <svg id="wind-arrow" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M4 12 L16 12 M16 12 L12 8 M16 12 L12 16" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                </svg>
                Rüzgar: <span id="wind-strength">0</span> m/s
            </div>

            <div id="game-over-screen" class="hidden">
                <h2 class="text-6xl font-bold text-red-500 font-['Cinzel'] mb-4">Oyun Bitti</h2>
                <p class="text-3xl text-white mb-8">Toplam Puan: <span id="final-score">0</span></p>
                <button id="restart-btn" class="bg-yellow-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-yellow-700 transition-all duration-300 transform hover:scale-105 text-xl">
                    Yeniden Başla
                </button>
            </div>
            
            <div id="message-container" class="text-center absolute bottom-1/2 left-1/2 -translate-x-1/2 z-30 h-12">
                <p id="message" class="text-5xl font-bold transition-opacity duration-300 opacity-0 text-white" style="text-shadow: 2px 2px 5px black;"></p>
            </div>
            </div><!-- game-container -->
        </div><!-- game-wrapper -->
        
    </div>

    <script>
        // DOM Elementleri
        const introScreen = document.getElementById('intro-screen');
        const gameWrapper = document.getElementById('game-wrapper');
        const startActivityBtn = document.getElementById('start-activity-btn');
        const gameContainer = document.getElementById('game-container');
        const scoreElement = document.getElementById('score');
        const messageElement = document.getElementById('message');
        const arrow = document.getElementById('arrow');
        const bowStringSvg = document.getElementById('bow-string-svg');
        const bowStringPath = document.getElementById('bow-string-path');
        const powerMeter = document.getElementById('power-meter');
        const powerFill = document.getElementById('power-fill');
        const windIndicator = document.getElementById('wind-indicator');
        const windStrengthElement = document.getElementById('wind-strength');
        const windArrowElement = document.getElementById('wind-arrow');
        const livesContainer = document.getElementById('lives-container');
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreElement = document.getElementById('final-score');
        const restartBtn = document.getElementById('restart-btn');

        // Oyun Verileri
        const landforms = {
            river: ["Delta Ovası", "Menderes", "Dev Kazanı", "Birikinti Konisi", "Vadi", "Irmak Adası", "Taraça (Seki)"],
            other: ["Falez (Yalıyar)", "Barkan", "Mantar Kaya", "Hörgüç Kaya", "Moren", "Tombolo", "Sirk Gölü", "Lapya"]
        };

        // Oyun Durumu
        let score, lives, isRoundActive, power, isCharging, windOscillator, windX, windY, bowAngle, flyingArrow;
        
        // --- ÇEKİRDEK OYUN MANTIĞI ---

        function startGame() {
            score = 0;
            lives = 3;
            isRoundActive = false;
            power = 0;
            isCharging = false;
            bowAngle = 0;
            flyingArrow = null;
            
            scoreElement.textContent = score;
            gameOverScreen.classList.add('hidden');
            gameOverScreen.style.display = 'none';
            
            updateLivesUI();
            powerMeter.classList.remove('active');
            powerFill.style.width = '0%';
            
            // Rüzgarı başlat
            startWind();
            
            // HATA ÖNLEME: Oyun alanının çizilmesini bekle
            waitForLayout(nextRound);
        }

        function nextRound() {
            clearBoard();

            const correctItem = landforms.river[Math.floor(Math.random() * landforms.river.length)];
            const incorrectItem = landforms.other[Math.floor(Math.random() * landforms.other.length)];
            
            const items = Math.random() < 0.5 ? [correctItem, incorrectItem] : [incorrectItem, correctItem];

            const target1 = createTarget(items[0], items[0] === correctItem);
            const target2 = createTarget(items[1], items[1] === correctItem);
            
            positionTargets(target1, target2);

            gameContainer.appendChild(target1);
            gameContainer.appendChild(target2);

            isRoundActive = true; // Artık oyuncu tıklayabilir.
        }

        function showGameOver() {
            if (windOscillator) {
                clearInterval(windOscillator);
                windOscillator = null;
            }
            finalScoreElement.textContent = score;
            gameOverScreen.classList.remove('hidden');
            gameOverScreen.style.display = 'flex';
        }

        function startWind() {
            // Rastgele 360 derece yön
            const angle = Math.random() * Math.PI * 2;
            const strength = 3 + Math.random() * 5; // 3-8 m/s
            windX = Math.cos(angle) * strength;
            windY = Math.sin(angle) * strength;
            
            updateWindDisplay();
            
            // Daha gerçekçi rüzgar: Sık güncelleme, küçük değişimler
            windOscillator = setInterval(() => {
                // Rüzgar yönü ve gücü yavaşça değişir
                windX += (Math.random() - 0.5) * 1.5;
                windY += (Math.random() - 0.5) * 1.5;
                
                // Maksimum rüzgar gücünü sınırla
                const currentStrength = Math.sqrt(windX * windX + windY * windY);
                if (currentStrength > 10) {
                    windX = (windX / currentStrength) * 10;
                    windY = (windY / currentStrength) * 10;
                }
                
                updateWindDisplay();
            }, 800);
        }
        
        function updateWindDisplay() {
            // Rüzgar gücünü hesapla
            const windStrength = Math.sqrt(windX * windX + windY * windY);
            windStrengthElement.textContent = windStrength.toFixed(1);
            
            // Rüzgar yönünü hesapla (0 = sağ, 90 = aşağı, 180 = sol, 270 = yukarı)
            const windAngle = Math.atan2(windY, windX);
            const windAngleDeg = windAngle * 180 / Math.PI;
            
            // Rüzgar gücüne göre stil
            if (windStrength > 6) {
                windIndicator.classList.add('wind-strong');
            } else {
                windIndicator.classList.remove('wind-strong');
            }
            
            // Ok rotasyonu ve boyutu
            const scale = 0.9 + windStrength * 0.04;
            const opacity = 0.7 + Math.min(windStrength / 15, 0.3);
            
            // Hafif sallanma efekti için random offset
            const wobble = (Math.random() - 0.5) * (windStrength * 0.5);
            
            if (windStrength > 0.5) {
                windArrowElement.style.transform = `rotate(${windAngleDeg + wobble}deg) scale(${scale})`;
                windArrowElement.style.opacity = opacity;
            } else {
                windArrowElement.style.transform = 'rotate(0deg) scale(0.6)';
                windArrowElement.style.opacity = 0.3;
            }
        }

        function handleMouseMove(event) {
            if (flyingArrow) return; // Sadece ok uçarken dönmesin
            
            const containerRect = gameContainer.getBoundingClientRect();
            // Yay container'ın gerçek merkezi (translateY(80px) dahil)
            const bowCenterX = containerRect.left + containerRect.width / 2;
            const bowCenterY = containerRect.top + containerRect.height / 2 + 50;
            
            const mouseX = event.clientX;
            const mouseY = event.clientY;
            
            // Yayın açısını hesapla
            const dx = mouseX - bowCenterX;
            const dy = mouseY - bowCenterY;
            bowAngle = Math.atan2(dy, dx);
            
            // Yay ve oku döndür (SVG ok başlangıçta aşağı baktığı için +90)
            const angleDeg = (bowAngle * 180 / Math.PI);
            document.getElementById('bow-container').style.transform = `translateY(50px) rotate(${angleDeg + 90}deg)`;
        }

        function handleMouseDown(event) {
            if (!isRoundActive || isCharging || flyingArrow) return;
            isCharging = true;
            power = 0;
            powerMeter.classList.add('active');
            
            // Yay gerilme sesi
            const bowSound = new Audio('gerilme.mp3');
            bowSound.volume = 0.5;
            bowSound.play().catch(e => console.log('Ses çalınamadı:', e));
            window.bowSound = bowSound;
            
            const chargeInterval = setInterval(() => {
                if (!isCharging) {
                    clearInterval(chargeInterval);
                    if (window.bowSound) {
                        window.bowSound.pause();
                        window.bowSound.currentTime = 0;
                    }
                    updateBowString(0); // Gerilmeyi sıfırla
                    return;
                }
                power += 2;
                powerFill.style.width = `${Math.min(power, 100)}%`;
                
                // Yay gerilme animasyonu
                updateBowString(power);
                
                if (power >= 100) {
                    clearInterval(chargeInterval);
                }
            }, 50);
            window.chargeInterval = chargeInterval;
        }
        
        function updateBowString(powerLevel) {
            // Kirişi sadece gerilirken göster
            if (powerLevel > 0) {
                bowStringSvg.style.opacity = '1';
            } else {
                bowStringSvg.style.opacity = '0';
            }
            
            // Güç 0-100 arası, maksimum 15 birim geri çekme
            const pullback = (powerLevel / 100) * 15;
            
            // Yay açısının tersi yönünde gerilme
            // bowAngle 0 = sağa, 90 = aşağı, -90 = yukarı
            // Gerilme yay açısının 180 derece tersi yönünde olmalı
            const pullbackAngle = bowAngle + Math.PI; // 180 derece ekle
            const pullbackX = Math.cos(pullbackAngle) * pullback;
            const pullbackY = Math.sin(pullbackAngle) * pullback;
            
            // Yay kirişi gerilme eğrisi (quadratic bezier)
            // Normal: M 50,10 L 50,90
            // Çekilmiş: M 50,10 Q (50+pullbackX, 50+pullbackY) 50,90
            const stringPath = `M 50,10 Q ${50 + pullbackX},${50 + pullbackY} 50,90`;
            bowStringPath.setAttribute('d', stringPath);
            
            // Ok da aynı yönde geri çekilir (viewBox koordinatlarında)
            const arrowPullX = pullbackX * 0.8;
            const arrowPullY = pullbackY * 0.8;
            arrow.style.transform = `translate(calc(-50% + ${arrowPullX}px), calc(50% + ${arrowPullY}px))`;
        }

        function handleMouseUp(event) {
            if (!isCharging) return;
            isCharging = false;
            if (window.chargeInterval) {
                clearInterval(window.chargeInterval);
                window.chargeInterval = null;
            }
            // Gerilme sesini durdur
            if (window.bowSound) {
                window.bowSound.pause();
                window.bowSound.currentTime = 0;
                window.bowSound = null;
            }
            powerMeter.classList.remove('active');
            
            // Ok atışını başlat
            if (power > 5) {
                fireArrow();
            } else {
                isRoundActive = true;
                updateBowString(0); // Gerilmeyi sıfırla
            }
            
            power = 0;
            powerFill.style.width = '0%';
        }

        function createStuckArrow(x, y, fadeQuickly = false) {
            const stuckArrow = document.createElement('div');
            stuckArrow.className = 'stuck-arrow';
            stuckArrow.style.left = `${x}px`;
            stuckArrow.style.top = `${y}px`;
            // Flying arrow ile aynı görünüm
            stuckArrow.innerHTML = '<svg viewBox="0 0 100 100"><line x1="50" y1="0" x2="50" y2="90" stroke="#a0522d" stroke-width="5"/><path d="M 50,0 L 43,15 L 57,15 Z" fill="#c0c0c0" stroke="#999" stroke-width="1"/><path d="M 45,85 L 50,90 L 55,85" fill="none" stroke="#8b4513" stroke-width="3"/></svg>';
            gameContainer.appendChild(stuckArrow);
            
            // Doğru hedefe isabet: 500ms, Yanlış hedefe: 700ms
            const fadeTime = fadeQuickly ? 500 : 700;
            
            if (fadeQuickly) {
                // Hedefle birlikte fade out (doğru hedef)
                setTimeout(() => {
                    stuckArrow.style.transition = 'opacity 0.3s, transform 0.3s';
                    stuckArrow.style.opacity = '0';
                    stuckArrow.style.transform = 'translate(-50%, -50%) scale(1.5)';
                }, 200);
            } else {
                // Yanlış hedef - çok kısa bekle, hızlı fade
                setTimeout(() => {
                    stuckArrow.style.transition = 'opacity 0.3s';
                    stuckArrow.style.opacity = '0';
                }, 400);
            }
            
            setTimeout(() => stuckArrow.remove(), fadeTime);
        }
        
        function createImpactEffect(x, y, isCorrect) {
            // Kamera shake
            gameContainer.classList.add('shake');
            setTimeout(() => gameContainer.classList.remove('shake'), 300);
            
            // Screen flash
            const flash = document.createElement('div');
            flash.style.position = 'absolute';
            flash.style.left = '0';
            flash.style.top = '0';
            flash.style.width = '100%';
            flash.style.height = '100%';
            flash.style.background = isCorrect ? 'rgba(76, 175, 80, 0.3)' : 'rgba(244, 67, 54, 0.3)';
            flash.style.pointerEvents = 'none';
            flash.style.zIndex = '99';
            gameContainer.appendChild(flash);
            setTimeout(() => flash.remove(), 100);
            
            // Partikül patlaması
            const particleCount = 12;
            const color = isCorrect ? '#4caf50' : '#f44336';
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                particle.style.background = color;
                
                const angle = (Math.PI * 2 * i) / particleCount;
                const distance = 40 + Math.random() * 30;
                const tx = Math.cos(angle) * distance;
                const ty = Math.sin(angle) * distance;
                
                particle.style.setProperty('--tx', `${tx}px`);
                particle.style.setProperty('--ty', `${ty}px`);
                particle.style.animation = `particleBurst ${0.4 + Math.random() * 0.3}s ease-out forwards`;
                
                gameContainer.appendChild(particle);
                setTimeout(() => particle.remove(), 700);
            }
        }

        // --- YARDIMCI VE UI FONKSİYONLARI ---

        function createTarget(text, isCorrect) {
            const target = document.createElement('div');
            const depth = Math.random() > 0.5 ? 'near' : 'far';
            target.className = `target ${depth}`;
            target.innerHTML = `<p class="p-2">${text}</p>`;
            target.dataset.correct = isCorrect;
            return target;
        }

        function positionTargets(target1, target2) {
            const gameWidth = gameContainer.clientWidth;
            const gameHeight = gameContainer.clientHeight;
            const size = 85;
            
            // Sol hedef: Ekranın sol çeyreğinde (15%-35% arası)
            const leftMinX = gameWidth * 0.15;
            const leftMaxX = gameWidth * 0.35 - size;
            target1.style.left = `${leftMinX + Math.random() * (leftMaxX - leftMinX)}px`;
            
            // Sağ hedef: Ekranın sağ çeyreğinde (65%-85% arası)
            const rightMinX = gameWidth * 0.65;
            const rightMaxX = gameWidth * 0.85 - size;
            target2.style.left = `${rightMinX + Math.random() * (rightMaxX - rightMinX)}px`;
            
            // Her iki hedef de üst kısımda (5%-40% arası)
            const minY = gameHeight * 0.05;
            const maxY = gameHeight * 0.40 - size;
            target1.style.top = `${minY + Math.random() * (maxY - minY)}px`;
            target2.style.top = `${minY + Math.random() * (maxY - minY)}px`;
            
            target2.style.animationDelay = '3s';
        }

        function fireArrow() {
            isRoundActive = false;
            arrow.style.display = 'none';
            updateBowString(0); // Gerilmeyi sıfırla
            
            // Ok sesi çal
            const arrowSound = new Audio('arrow.wav');
            arrowSound.play().catch(e => console.log('Ses çalınamadı:', e));
            
            // Yay merkezinden ok başlangıcını hesapla
            const startX = gameContainer.clientWidth / 2;
            const startY = gameContainer.clientHeight / 2 + 50;
            
            // Ok hızını hesapla (yavaşlatıldı: 0.25 -> 0.18)
            const speed = power * 0.18;
            const vx = Math.cos(bowAngle) * speed;
            const vy = Math.sin(bowAngle) * speed;
            
            flyingArrow = {
                x: startX,
                y: startY,
                vx: vx,
                vy: vy,
                angle: bowAngle,
                element: createFlyingArrow(startX, startY, bowAngle)
            };
            
            animateArrowFlight();
        }
        
        function createFlyingArrow(x, y, angle) {
            const arrowEl = document.createElement('div');
            arrowEl.className = 'flying-arrow';
            arrowEl.style.position = 'absolute';
            arrowEl.style.left = `${x}px`;
            arrowEl.style.top = `${y}px`;
            arrowEl.style.width = '70px';
            arrowEl.style.height = '70px';
            arrowEl.style.transform = `translate(-50%, -50%) rotate(${angle * 180 / Math.PI}deg)`;
            arrowEl.style.zIndex = '50';
            arrowEl.style.pointerEvents = 'none';
            arrowEl.style.filter = 'drop-shadow(2px 2px 3px rgba(0,0,0,0.5))'; // Gölge ekle
            arrowEl.innerHTML = '<svg viewBox="0 0 100 100"><line x1="50" y1="0" x2="50" y2="90" stroke="#a0522d" stroke-width="5"/><path d="M 50,0 L 43,15 L 57,15 Z" fill="#c0c0c0" stroke="#999" stroke-width="1"/><path d="M 45,85 L 50,90 L 55,85" fill="none" stroke="#8b4513" stroke-width="3"/></svg>';
            gameContainer.appendChild(arrowEl);
            return arrowEl;
        }
        
        function animateArrowFlight() {
            if (!flyingArrow) return;
            
            // Hedef çarpışma kontrolü (pozisyon güncellemeden ÖNCE)
            checkArrowCollision();
            
            // Çarpışma oldu mu kontrol et
            if (!flyingArrow) return;
            
            // Minimal hava direnci (subtle, barely noticeable)
            flyingArrow.vx *= 0.995;
            flyingArrow.vy *= 0.995;
            
            // Yerçekimi
            flyingArrow.vy += 0.2;
            
            // Rüzgar etkisi
            flyingArrow.vx += windX * 0.02;
            flyingArrow.vy += windY * 0.02;
            
            // Pozisyon güncelle
            flyingArrow.x += flyingArrow.vx;
            flyingArrow.y += flyingArrow.vy;
            
            // Okun açısını güncelle (hareket yönüne göre)
            flyingArrow.angle = Math.atan2(flyingArrow.vy, flyingArrow.vx);
            
            flyingArrow.element.style.left = `${flyingArrow.x}px`;
            flyingArrow.element.style.top = `${flyingArrow.y}px`;
            flyingArrow.element.style.transform = `translate(-50%, -50%) rotate(${flyingArrow.angle * 180 / Math.PI}deg)`;
            
            // Sınır kontrolü
            if (flyingArrow && (flyingArrow.y > gameContainer.clientHeight || flyingArrow.y < 0 || 
                flyingArrow.x < 0 || flyingArrow.x > gameContainer.clientWidth)) {
                missedShot();
                return;
            }
            
            if (flyingArrow) {
                requestAnimationFrame(animateArrowFlight);
            }
        }
        
        function checkArrowCollision() {
            if (!flyingArrow) return;
            
            const targets = gameContainer.querySelectorAll('.target');
            for (const target of targets) {
                const targetRect = target.getBoundingClientRect();
                const containerRect = gameContainer.getBoundingClientRect();
                const targetX = targetRect.left - containerRect.left + targetRect.width / 2;
                const targetY = targetRect.top - containerRect.top + targetRect.height / 2;
                const targetRadius = targetRect.width / 2;
                
                const distance = Math.sqrt(
                    Math.pow(flyingArrow.x - targetX, 2) + 
                    Math.pow(flyingArrow.y - targetY, 2)
                );
                
                if (distance < targetRadius) {
                    hitTarget(target);
                    return; // Çarpışma oldu, başka hedef kontrol etme
                }
            }
        }
        
        function hitTarget(target) {
            const isCorrect = target.dataset.correct === 'true';
            
            // Ok konumunu kaydet
            const arrowX = flyingArrow.x;
            const arrowY = flyingArrow.y;
            
            // Uçan oku temizle
            if (flyingArrow && flyingArrow.element) {
                flyingArrow.element.remove();
            }
            flyingArrow = null;
            
            // Impact efekti oluştur
            createImpactEffect(arrowX, arrowY, isCorrect);
            
            if (isCorrect) {
                // DOĞRU HEDEF - Yırtılma efekti
                score += 5;
                showMessage('Doğru!', 'text-green-400');
                
                // Target shatter animasyonu
                target.classList.add('shatter');
                
                // Stuck arrow ekle (hedefle birlikte kaybolur)
                createStuckArrow(arrowX, arrowY, true); // fadeQuickly = true
                
            } else {
                // YANLIŞ HEDEF - Sadece border
                score -= 5;
                lives--;
                showMessage('Yanlış!', 'text-red-500');
                target.style.borderColor = '#f87171';
                target.classList.add('hit');
                
                // Stuck arrow ekle (uzun süre kalır)
                createStuckArrow(arrowX, arrowY, false);
                
                updateLivesUI();
            }
            
            scoreElement.textContent = score;
            
            setTimeout(() => {
                if (lives > 0) {
                    nextRound();
                } else {
                    showGameOver();
                }
            }, 1800);
        }
        
        function missedShot() {
            if (flyingArrow && flyingArrow.element) {
                flyingArrow.element.remove();
            }
            flyingArrow = null;
            
            scoreElement.textContent = score;
            showMessage('Iskaladın!', 'text-yellow-500');
            
            setTimeout(() => {
                // Hedefler aynı kalır, sadece ok ve stuck arrow'lar temizlenir
                gameContainer.querySelectorAll('.stuck-arrow').forEach(a => a.remove());
                gameContainer.querySelectorAll('.flying-arrow').forEach(a => a.remove());
                arrow.style.display = 'block';
                messageElement.classList.add('opacity-0');
                isRoundActive = true;
            }, 1500);
        }

        function updateLivesUI() {
            livesContainer.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const heart = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                heart.setAttribute('class', `w-8 h-8 heart ${i >= lives ? 'lost' : ''}`);
                heart.setAttribute('viewBox', '0 0 24 24');
                heart.innerHTML = '<path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>';
                livesContainer.appendChild(heart);
            }
        }
        
        function clearBoard() {
            gameContainer.querySelectorAll('.target').forEach(t => t.remove());
            gameContainer.querySelectorAll('.stuck-arrow').forEach(a => a.remove());
            gameContainer.querySelectorAll('.flying-arrow').forEach(a => a.remove());
            messageElement.classList.add('opacity-0');
            arrow.style.display = 'block';
            arrow.classList.remove('fired', 'flying');
            arrow.style.top = '';
            arrow.style.left = '';
            arrow.style.transform = 'translate(-50%, 50%)';
            document.getElementById('bow-container').style.transform = 'translateY(50px) rotate(0deg)';
            updateBowString(0); // Gerilmeyi sıfırla
            powerMeter.classList.remove('active');
            powerFill.style.width = '0%';
            bowAngle = 0;
            flyingArrow = null;
        }

        function showMessage(text, colorClass) {
            messageElement.textContent = text;
            messageElement.className = `text-5xl font-bold transition-opacity duration-300 opacity-100 ${colorClass}`;
            messageElement.style.textShadow = '2px 2px 5px black';
        }

        // *** KRİTİK HATA DÜZELTME FONKSİYONU ***
        function waitForLayout(callback) {
            // Oyun alanının genişliği 0 ise, tarayıcı henüz onu çizmemiştir.
            if (gameContainer.clientWidth === 0) {
                // Bir sonraki animasyon karesinde tekrar kontrol et.
                requestAnimationFrame(() => waitForLayout(callback));
            } else {
                // Alan çizildi, artık oyunu güvenle başlatabiliriz.
                callback();
            }
        }

        // --- BAŞLANGIÇ EKRANI VE OYUN GEÇİŞİ ---
        function startActivity() {
            introScreen.classList.add('hidden');
            gameWrapper.classList.remove('hidden');
            // Oyunu başlat
            setTimeout(() => {
                startGame();
            }, 100);
        }
        
        // Tam ekran fonksiyonu
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        fullscreenBtn.addEventListener('click', () => {
            const elem = document.documentElement;
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        });
        
        // --- OYUNU BAŞLATMA ---
        startActivityBtn.addEventListener('click', startActivity);
        restartBtn.addEventListener('click', startGame);
        
        // Mouse events
        gameContainer.addEventListener('mousemove', handleMouseMove);
        gameContainer.addEventListener('mousedown', handleMouseDown);
        document.addEventListener('mouseup', handleMouseUp);
        gameContainer.addEventListener('touchmove', (e) => { handleMouseMove(e.touches[0]); });
        gameContainer.addEventListener('touchstart', (e) => { handleMouseDown(e.touches[0]); });
        document.addEventListener('touchend', (e) => { handleMouseUp(e.changedTouches[0]); });
    </script>
</body>
</html>

